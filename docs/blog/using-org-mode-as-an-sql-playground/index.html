<html lang=en><head><meta charset=UTF-8><title>Using org-mode as an SQL playground</title><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/atom+xml title="RSS Feed" href=/archive/feed.xml><style>:root{--bg:#fcfcfc;--bg-d1:#efefef;--bg-d2:#ececec;--primary:#006992;--secondary:#465c69;--cta:#b75d69;--cta-em1:#b75d69;--cta-em2:#b75d69;--primary-text:#010400;--dim-text:#6f6f6f;--separator:#888;--separator-em1:#6f6f6f29;--success:green;--warning:orange;--error:red;}@font-face{font-family:Roboto;font-style:normal;font-weight:300;font-display:swap;src:url("/fonts/roboto-thin.woff2");}@font-face{font-family:Roboto;font-style:normal;font-weight:500;font-display:swap;src:url("/fonts/roboto-regular.woff2");}@font-face{font-family:Roboto;font-style:normal;font-weight:bold;font-display:swap;src:url("/fonts/roboto-bold.woff2");}@font-face{font-family:Cantarell;font-style:normal;font-weight:bold;font-display:swap;src:url("/fonts/Cantarell-Bold.ttf");}@font-face{font-family:Cantarell;font-style:normal;font-weight:regular;font-display:swap;src:url("/fonts/Cantarell-Regular.ttf");}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:Cantarell, sans-serif;font-size:14px;background:var(--bg);color:var(--primary-text);}.title,header{font-family:Roboto, sans-serif;}a{text-decoration:underline;color:var(--primary-text);}h1,h2,h3,h4,h5,h6{font-family:Roboto, sans-serif;margin:4rem 0 2rem 0;}img figcaption,figure figcaption{padding:0.4em;padding-top:0;border-bottom:2px solid var(--secondary);font-size:0.7em;}ol,ul{padding-left:0.8rem;}blockquote{padding:0.01em 1em;margin:1em 0;border-left:4px solid var(--secondary);font-size:1.2em;}pre{overflow:auto;padding:1em;font-family:monospace;font-size:1.2rem;}code{font-family:monospace;color:var(--cta);font-size:1rem;}.title{margin:2rem 0;}.title h1{font-family:Roboto, sans-serif;font-weight:bold;font-size:1.7em;line-height:1.2;text-transform:capitalize;}video{width:100%;}col{min-width:10rem;}tr:nth-child(even){background-color:var(--bg-d2);}td{padding:.4em .8em;}.src{font-size:1rem;padding:1em;border:1px solid var(--separator-em1);border-radius:8px;box-sizing:scroll;margin:2em 0;}.content{font-family:Cantarell, sans-serif;font-style:normal;font-weight:500;font-size:1.5em;line-height:1.4;margin:0 auto;padding:0 124px;}.content{max-width:1080px;padding:0 124px;margin:0 auto;}@media (max-width: 840px){.content{max-width:100%;padding:0 8%;}}@media (max-width: 520px){.content{max-width:100%;padding:0 4%;}}.content-header h1{margin-bottom:1rem;font-size:2em;}.content-meta{margin-top:0;margin-bottom:2rem;font-family:Roboto, sans-serif;color:var(--secondary);display:flex;}.content-meta .meta-item{border-right:1px solid var(--separator);line-height:1;padding:0 1rem;font-size:0.8rem;display:flex;}.content-meta .meta-item:last-child{padding-right:0;border:none;}.content-meta .date{padding:0;padding-right:1rem;}.content-meta .tags{list-style-type:none;display:flex;flex-wrap:wrap;}.content-meta .tags li{padding-right:1rem;}.content-meta .tags li a{color:var(--secondary);}.main-article{font-family:Cantarell, sans-serif;min-height:500px;}.main-article strong,.main-article b{font-weight:bold;}.main-article p{font-family:inherit;font-size:inherit;margin:1rem 0;}.main-article h3{margin:1.2rem 0 0.4rem 0;}.main-article a{text-decoration:underline;}.main-article ul{margin-left:1.4rem;}.main-article li{margin:0.7rem;margin-right:0;}.rss-sub{margin:2rem 0;}.rss-sub a{display:flex;align-items:center;}.rss-sub a .rss{width:24px;height:24px;margin-right:1rem;background:url("/images/icons/rss.svg");background-repeat:no-repeat;background-size:contain;}.postamble{max-width:1080px;padding:0 124px;margin:0 auto;}@media (max-width: 840px){.postamble{max-width:100%;padding:0 8%;}}@media (max-width: 520px){.postamble{max-width:100%;padding:0 4%;}}.btn{display:inline-flex;border:2px solid;border-radius:25px;padding:0 2.1rem;cursor:pointer;font-family:Roboto;font-weight:normal;line-height:2.2rem;align-items:center;text-align:center;background-color:var(--bg);text-decoration:none;}.btn:hover{background-color:var(--bg-d1);}.btn:active{background:var(--bg-d2);}.btn[disabled]:hover{background:var(--bg);cursor:default;}.btn-cta{border-color:var(--cta);background:var(--cta);color:var(--bg);}.btn-cta:hover{background:var(--cta-em1);}.btn-cta:active{background:var(--cta-em2);}.btn-primary{border-color:var(--primary);color:var(--primary);background:var(--bg);}.btn-primary:hover{background:var(--bg-d1);}.btn-primary:active{background:var(--bg-d2);}.btn-secondary{border-color:var(--secondary);color:var(--secondary);background:var(--bg);}.btn-secondary:hover{background:var(--bg-d1);}.btn-secondary:active{background:var(--bg-d2);}.postamble{font-family:monospace;color:#666;margin:4rem auto;}.postamble .validation{display:none;}@media (max-width: NIL){.postamble{max-width:100%;padding:0 8%;}}@media (max-width: NIL){.postamble{max-width:100%;padding:0 4%;}}#mc_embed_signup{max-width:600px;background:transparent;margin-bottom:4rem;}.newsletter-email{border:1px solid var(--secondary);border-radius:25px;width:100%;margin-bottom:1rem;padding:0.4rem 0.8rem;}.top-nav{height:90px;display:flex;position:relative;justify-content:space-between;}.top-nav ul{list-style-type:none;display:flex;align-items:center;padding:2em 0;}.top-nav li{flex-grow:1;padding-right:2em;}.top-nav li a{text-decoration:underline;font-size:1.4em;font-family:roboto, sans-serif;color:var(--primary);}.top-nav li a:hover{color:var(--secondary);}.top-nav li:last-child{padding:0;}.top-nav .brand{width:60px;height:60px;align-self:center;flex-grow:1;}.top-nav .brand-avatar{height:100%;}@media (max-width: 520px){.top-nav{padding-right:1em;}.top-nav a{font-size:1.2em;}}.top-nav{max-width:1080px;padding:0 124px;margin:0 auto;}@media (max-width: 840px){.top-nav{max-width:100%;padding:0 8%;}}@media (max-width: 520px){.top-nav{max-width:100%;padding:0 4%;}}</style></head><body><div><nav class=top-nav><div class=brand><a href="/"><img class=brand-avatar src=/images/spooky-avatar.png alt="Charanjit Singh"></a></div><div><ul><li><a href=/blog>Blog</a></li><li><a href=/poems>Poems</a></li><li><a href=/projects>Projects</a></li></ul></div></nav><section class=content><header class=content-header><h1>Using org-mode as an SQL playground</h1><span class=content-meta><span class="meta-item date">February 3, 2022</span><ul class="meta-item tags"><li class=tag><a href=/tags/org-mode>#org-mode</a></li><li class=tag><a href=/tags/emacs>#emacs</a></li><li class=tag><a href=/tags/workflow>#workflow</a></li><li class=tag><a href=/tags/video>#video</a></li></ul></span></header><article class=main-article><p>
Showcase video:
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/DY7t4T4TmUU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>
For every web app I work on, a database client is always present for exploring
data and building complex queries. Recently, I have moved on from my PgAdmin to
org-mode for this purpose, because why not.
</p>

<p>
Org-mode allows executing code snippets and can show results in a nice tabular
form. But org-mode isn't <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-26/product_id-320/Microsoft-Office.html">written by Microsoft</a>. So it don't allow arbitrary code
execution without our explicit consent. To tell org-mode that it is okay to
execute SQL snippets, we need to run following elisp snippet:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #598bc1;">with-eval-after-load</span> 'org
(org-babel-do-load-languages
 'org-babel-load-languages
 '((sql . t))))
</pre>
</div>

<p>
Org-mode has a number of <a href="https://www.orgmode.org/worg/org-contrib/babel/languages/ob-doc-sql.html#org7f0941b">header arguments for SQL blocks</a> which can be used to
configure how a particular SQL source-code snippet is executed. Most important
ones perhaps are:
</p>

<ul class="org-ul">
<li><code>:engine</code> which tells which database to run the SQL against</li>
<li><code>:dbhost</code> to configure the database host, most likely <code>localhost</code> for a dev
environment</li>
<li><code>:dbport</code></li>
<li><code>:dbuser</code> and <code>:dbpassword</code> for database authentication</li>
<li><code>:database</code> for database name</li>
</ul>

<p>
By default org-mode runs the code snippets in current OS environment. I use this
fact to get the ability to run SQL against our postgres database without passing
most of the above arguments. Postgres allows setting <a href="https://www.postgresql.org/docs/current/libpq-envars.html">some environment</a> variables,
which it then use to for making connections by default. In my <a href="https://github.com/bitspook/entropy/blob/ae5ee52646c2c67ce713938548d67a722b73a294/flake.nix">flake.nix</a> file, I
setup the required environment variables:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b6b635;">PGDIR</span>=$<span style="color: #b6b635;">PWD</span>/storage/postgres
<span style="color: #7f7dca;">export</span> <span style="color: #b6b635;">PGDATA</span>=$<span style="color: #b6b635;">PGDIR</span>/data
<span style="color: #7f7dca;">export</span> <span style="color: #b6b635;">PGHOST</span>=$<span style="color: #b6b635;">PGDIR</span>/run
<span style="color: #7f7dca;">export</span> <span style="color: #b6b635;">PGDATABASE</span>=entropy
<span style="color: #7f7dca;">export</span> <span style="color: #b6b635;">DATABASE_URL</span>=<span style="color: #6aaf50;">"postgresql:///$PGDATABASE?host=$PGHOST"</span> <span style="color: #858585; font-style: italic;"># </span><span style="color: #858585; font-style: italic;">not required by postgres, but will be helpful</span>
</pre>
</div>

<p>
With this, only header option left to set is <code>:engine</code>, which I prefer to
configure globally for my <a href="https://raw.githubusercontent.com/bitspook/entropy/96cc9c0485d972ed819996d61c3730cafb228660/sql-playground.org">sql-playground.org</a> since I usually have one database
for my personal projects. You can check this <a href="https://github.com/bitspook/entropy/commit/96cc9c0485d972ed819996d61c3730cafb228660">commit on Entropy project</a> for how I
have setup my sql-playground there. Following snippet on top of the
sql-playground.org does the trick:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #858585; font-style: italic;">#+PROPERTY: header-args:sql  :engine postgres</span>
</pre>
</div>

<p>
Now any SQL snippets that we create can be executed against our development
database right within the org file. For example, pressing <code>C-c C-c</code> in following
SQL block produces output shown below that.
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #858585; font-style: italic;">#+name: events</span>
<span style="color: #858585; font-style: italic; text-decoration: underline;">#+begin_src sql</span>
<span style="color: #858585;">  </span><span style="color: #598bc1;">SELECT</span><span style="color: #858585;"> events.title,</span>
<span style="color: #858585;">         events.slug,</span>
<span style="color: #858585;">         start_time,</span>
<span style="color: #858585;">         events.id,</span>
<span style="color: #858585;">         events.</span><span style="color: #598bc1;">source</span><span style="color: #858585;">,</span>
<span style="color: #858585;">         format(</span><span style="color: #6aaf50;">'%s mins'</span><span style="color: #858585;">, </span><span style="color: #7f7dca;">extract</span><span style="color: #858585;">(epoch </span><span style="color: #598bc1;">from</span><span style="color: #858585;"> (events.end_time - events.start_time))/60)</span>
<span style="color: #858585;">  </span><span style="color: #598bc1;">FROM</span><span style="color: #858585;"> events;</span>
<span style="color: #858585; font-style: italic; text-decoration: overline;">#+end_src</span>

<span style="color: #858585; font-style: italic;">#+RESULTS: events</span>
<span style="color: #86b5e8;">| title              | slug                 | start_time          | end_time            | source | format  |</span>
<span style="color: #86b5e8;">|--------------------+----------------------+---------------------+---------------------+--------+---------|</span>
<span style="color: #86b5e8;">| Lol bro what       | lol-rofl-lmao        | 2021-11-29 12:30:00 | 2021-11-29 13:30:00 | local  | 60 mins |</span>
<span style="color: #86b5e8;">| Nested event title | nested-lol-rofl-lmao | 2021-10-29 12:30:00 | 2021-10-29 13:30:00 | local  | 60 mins |</span>
</pre>
</div>

<div id="outline-container-org0b6f9e8" class="outline-2">
<h2 id="org0b6f9e8">Utilizing LSP</h2>
<div class="outline-text-2" id="text-org0b6f9e8">
<p>
Building SQL queries is my primary use-case, and org-mode configured so far
serves that purpose. But since I am putting all this effort in writing this blog
post anyway, I thought let's go a step further and try configuring LSP mode for
SQL snippets in my org file. To my surprise, it is possible. <a href="https://github.com/lighttiger2505/sqls/">SQLS</a> provides an
LSP server for SQL files, which once configured can provide certain features
like auto-completing table and column names. I have created a <a href="https://github.com/bitspook/entropy/blob/96cc9c0485d972ed819996d61c3730cafb228660/.dir-locals.el">.dir-locals</a> file
for <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Directory-Variables.html">adding directory local variables</a> to configure LSP to connect to correct
database.
</p>

<div class="org-src-container">
<pre class="src src-elisp">((nil . ((eval (<span style="color: #598bc1;">lambda</span> ()
                 (<span style="color: #598bc1;">setq</span> lsp-sqls-connections `(((driver . <span style="color: #6aaf50;">"postgresql"</span>)
                                               (dataSourceName . ,(getenv <span style="color: #6aaf50;">"DATABASE_URL"</span>))))))))))
</pre>
</div>

<p>
This snippet isn't actually the right way configuring directory local variables,
becuase it sets <code>lsp-sqls-connections</code> globally. This is the result of me
time-boxing the task of evaluating <code>(getenv "DATABASE_URL")</code>, so I won't need to
duplicate my database configuration here.
</p>

<p>
LSP for org-mode also need to provide a file to which it can tangle source
blocks. So I added another snippet to top of my org file.
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #858585; font-style: italic;">#+PROPERTY: header-args:sql  :tangle test.sql</span>
</pre>
</div>

<p>
I can now run <code>lsp-org</code> in an SQL block, and 8/10 times it has lsp configured
properly. It isn't flawless though, but that is expected since <a href="https://emacs-lsp.github.io/lsp-mode/manual-language-docs/lsp-org/#">lsp support in
org-snippets</a> is in alpha stage right now.
</p>

<p>
I also tried setting up lsp support in edit buffer for SQL statements (which you
get by pressing <code>C-c '</code> in org src blocks), but because of a <a href="https://github.com/emacs-lsp/lsp-mode/issues/2525">bug in lsp-mode</a>,
that didn't work out too well.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #598bc1;">defun</span> <span style="color: #1d9a79;">org-babel-edit-prep:sql</span> (babel-info)
  (<span style="color: #598bc1;">setq-local</span> buffer-file-name (<span style="color: #598bc1;">-&gt;&gt;</span> babel-info caddr (alist-get <span style="color: #7f7dca;">:tangle</span>)))
  (<span style="color: #598bc1;">setq-local</span> lsp-buffer-uri (<span style="color: #598bc1;">-&gt;&gt;</span> babel-info caddr (alist-get <span style="color: #7f7dca;">:tangle</span>) lsp--path-to-uri))
  (<span style="color: #598bc1;">setq-local</span> lsp-headerline-breadcrumb-enable nil)
  (lsp))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1508ecd" class="outline-2">
<h2 id="org1508ecd">Problems with this setup</h2>
<div class="outline-text-2" id="text-org1508ecd">
<p>
There are 2 main problems I face during my primary use-case.
</p>

<ol class="org-ol">
<li>Org tables don't work well if a column has a lot of data. e.g <code>description</code>
of an <code>event</code> messes up the table real bad. lsp-mode allow executing queries
which don't suffer from this.</li>
<li>No LSP support in edit buffer is a major bummer.</li>
</ol>
</div>
</div>
</article></section><footer class="site-footer postamble"><div id=mc_embed_signup><form class=validate action="https://bitspook.us14.list-manage.com/subscribe/post?u=de25614414d7e23ac4c3ea700&amp;id=b8b47d5b6e" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form target=_blank><div id=mc_embed_signup_scroll><h2>Get updates via email</h2><div class=mc-field-group><input class="required email newsletter-email" type=email value="" placeholder="Email Address" name=EMAIL id=mce-EMAIL></div><div style="position: absolute; left: -5000px;" aria-hidden=true><input type=text name=b_de25614414d7e23ac4c3ea700_b8b47d5b6e tabindex=-1 value=""></div><div class="clear foot" id=mce-responses><div class=response id=mce-error-response style="display: none"></div><div class=response id=mce-success-response style="display: none"></div></div><div class=optionalParent><div class="clear foot"><input class="btn btn-primary" type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe></div></div></div></form></div><p class=rss-sub><a href=/archive/feed.xml title="Follow via RSS" target=blank><span class=rss></span>Or Follow via RSS</a></p><p>Author: Charanjit Singh <a href=https://infosec.exchange/@bitspook>@bitspook</a></p></footer><script type=text/javascript>(function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
MIXPANEL_CUSTOM_LIB_URL:"file:"===f.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);mixpanel.init('0f28a64d9f8bce370006d36e1e2e3f61');mixpanel.track('Page Load');</script></div></body></html>